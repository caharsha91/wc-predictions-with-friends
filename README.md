# wc-predictions-with-friends

Simple World Cup predictions app for a private league with my friends: picks, points, and bragging rights.

## App Flow (Current)

- `/` redirects to `/play`
- `/play` play center workspace (default member entry)
- `/play/picks` picks detail (read-only + embedded results)
- `/play/group-stage` group stage detail (read-only + standings/results)
- `/play/bracket` knockout detail (read-only; active after group close + draw readiness)
- `/play/league` standings
- `/demo/play` demo play center (admin only)
- `/demo/play/picks` demo picks detail (read-only + embedded results) (admin only)
- `/demo/play/group-stage` demo group stage detail (read-only + standings/results) (admin only)
- `/demo/play/bracket` demo knockout detail (read-only; fixture-activated or forced active for selected demo knockout scenarios) (admin only)
- `/demo/play/league` demo standings (admin only)
- `/demo/admin/controls` demo controls (scenario/viewer/session) (admin only)
- `/demo/admin/players` demo member manager (admin only)
- `/demo/admin/exports` demo export tools (admin only)
- `/admin/players` member manager (admin only)
- `/admin/exports` export tools (admin only)
- `/settings` account and appearance settings
- `/login` sign-in guidance
- `/access-denied` unauthorized state
- `*` not found

Snapshot data lives in `public/data/` (`matches.json`, `members.json`, `picks.json`, `scoring.json`, `bracket-group.json`, `bracket-knockout.json`, `best-third-qualifiers.json`, `leaderboard.json`).
Demo snapshot data lives in per-scenario folders under `public/data/demo/scenarios/<scenario>/`.
`leaderboard.json` is generated by the leaderboard update script; do not hand-edit entries.

## Demo Mode Data + Storage

- Demo routes (`/demo/play/*`, `/demo/admin/*`) read from `public/data/demo/scenarios/<selected-scenario>/*`.
- Demo-mode caches and local edits are namespaced in localStorage to avoid mixing with normal mode.
- Demo mode disables Firestore writes (including picks, group stage, knockout, members admin edits, theme sync, and export backfills).
- Demo localStorage keys are explicitly cleared on logout and on page exit while in demo mode.
- `/demo/admin/controls` lets admins:
  - set scenario-based demo "now" timestamps for lock testing,
  - switch the active demo viewer user,
  - reload demo snapshots after running the simulation CLI,
  - clear demo session keys.

## Docs

- `skills.md` Codex project guide and pointers.
- `docs/pages/` page summaries for each route.

## How the App Works (Contributor Guide)

- Entry + routing: `src/main.tsx` bootstraps the app and applies theme attributes; `src/ui/App.tsx` defines routes; `src/ui/Layout.tsx` owns the shared header/nav shell.
- Data flow: `src/ui/hooks/*` fetches from Firestore when enabled (see `src/lib/firebase.ts`), otherwise reads mock JSON from `public/data/`. Static JSON fetches use HTTP caching + localStorage TTL to reduce reads. Picks updates flow through `src/lib/picks.ts`.
- Match grouping/locks: `src/lib/matches.ts` handles lock calculations and stage/date helpers.
- Scoring: `src/lib/scoring.ts` computes pick + bracket points from `public/data/scoring.json`, surfaced in leaderboard views.
- Theming: base tokens live in `src/styles/theme.css`, palettes in `src/styles/themes.css`, and state in `src/theme/ThemeProvider.tsx` with localStorage persistence + optional Firestore sync.
- Styling: Tailwind + shadcn/ui components, with remaining page-specific styles in `src/ui/styles.css`.
- UI primitives: reusable components are in `src/ui/components/ui/` and app-specific components in `src/ui/components/`.

## UI Toast Contract

- Provider/hook: use existing `ToastProvider` + `useToast` (`src/ui/hooks/useToast.tsx`).
- Placement: fixed top-right stack for all routes; do not add route-level overrides.
- Max visible stack: 4 toasts. New toasts beyond this should replace the oldest visible item.
- Tone mapping:
  - `success`: completed mutation/export
  - `danger`: failed mutation/export
  - `warning`: partial/degraded completion
  - `info`: non-blocking status
- Trust-signal metadata for mutating actions:
  - include `entityCount` when available (e.g., `Saved 12 picks`, `Updated 3 players`, `Exported 142 rows`)
  - include `durationMs` for batch operations when measurable
- Theming: use existing theme tokens/variables only; no hardcoded hex/rgb colors.

## UI Feature Flags (Dev/Demo)

- Source: `src/ui/lib/featureFlags.ts`
- Flags:
  - `navSimplification`
  - `playSocialSignals`
  - `leaderboardStory`
  - `adminConsoleTabs`
  - `exportsOutcomeFirst`
- Scope: flag overrides are only enabled in dev builds or `/demo/*` routes.
- Query param toggles:
  - `?ff=navSimplification,playSocialSignals`
  - `?ff.navSimplification=true`
- localStorage override key: `wc-ui-feature-flags` (JSON object of boolean keys).

## Dev

1. Install Node.js (v20+ recommended)
2. Install deps: `npm install`
3. Run: `npm run dev`

## Local Firebase (Emulators)

1. Install the Firebase CLI (one-time).
2. Ensure `.env.local` includes:
   - `VITE_USE_FIREBASE_EMULATORS=true`
   - `VITE_FIREBASE_EMULATOR_HOST=127.0.0.1`
   - `VITE_FIREBASE_AUTH_EMULATOR_PORT=9099`
   - `VITE_FIRESTORE_EMULATOR_PORT=8080`
3. Start emulators in a separate terminal: `firebase emulators:start`
4. Seed emulator data:
   - `VITE_USE_FIREBASE_EMULATORS=true FIREBASE_PROJECT_ID=demo-wc-predictions node scripts/seedEmulators.js`
5. Run the app: `npm run dev`

## Pick Locks (PST)

- Match picks lock 30 minutes before kickoff.
- Bracket group qualifiers + best third-place picks lock at 11:59 PM PST on the day before the first group match day.
- Bracket knockout picks lock at 11:59 PM PST on the day before the first knockout match day.
- Knockout eventual winner picks are independent of the result selection.

## Bracket Guides

- Group stage guide highlights group qualifiers + best third-place pick flow.
- Knockout guide explains inline team-pill picks and champion badge from the Final.

## Play Center Phase Behavior

- Play Center (`/play` and `/demo/play`) keeps match picks always active.
- Under Action Hub, sections are phase-ordered and compact:
  - default: Group Stage, Match Picks, Knockout
  - when `groupClosed`: Match Picks and Knockout move above a collapsed Group Stage row
  - when knockout is active: Knockout moves to top
- Play Center embeds compact wizards for:
  - Group stage (active group top-two + next best-third slot + save),
  - Knockout (next open matchup winner selection + save).
- Match-pick control buttons (`Continue`, `Next one`) are anchored inside the `Match picks` section for consistent section-first layout.
- Match-pick status UI (progress bar, metric pills, and closes/deadline pill) is anchored inside the `Match picks` section.
- Section cards use neutral/transparent surfaces for a more uniform visual hierarchy.
- Detailed pages (`/play/picks`, `/play/group-stage`, `/play/bracket` and demo equivalents) are read-only and include a compact header `Picks` link (quick menu removed).
- Detailed pages now embed inline post-result feedback:
  - actual results shown inline next to user predictions,
  - H1 status highlighting (`Correct`, `Wrong`, `Pending`) on rows/cards,
  - Group Stage shows per-group `Incomplete`/`Final` badges and inline top-two actuals,
  - Best-third qualifiers section shows pick-vs-actual status inline.
- Group-stage card is active before group kickoff; after kickoff it becomes inactive with view-only guidance.
- Knockout card activates only after:
  - group-stage completion, and
  - knockout draw readiness inferred from Round-of-32 team completeness in match data.
- Demo mode override: for `mid-knockout` and `world-cup-final-pending`, knockout is forced active even if fixture inference disagrees.
- When forced activation disagrees with fixture inference, Play Center and Bracket detail show a warning banner with a source-of-truth label.
- Knockout metrics/actions stay hidden or inactive until draw readiness.
- During active knockout window, knockout action card moves to the top of Play Center.

## Admin

- `/admin/players` is admin-only and manages member allowlist + admin role assignment.

## Firestore Data Model (when enabled)

- `leagues/{leagueId}/members/{email}` (doc id is lower-case email)
  - `email`, `name`, `handle?`, `isAdmin?`, `createdAt?`, `theme?`
- `leagues/{leagueId}/picks/{userId}` → one doc per user with all match picks
- `leagues/{leagueId}/bracket-group/{userId}` → one doc per user (group + best thirds)
- `leagues/{leagueId}/bracket-knockout/{userId}` → one doc per user (knockout winners)

JSON mirrors for local mode: `public/data/members.json`, `public/data/picks.json`, `public/data/bracket-group.json`, `public/data/bracket-knockout.json`.

## Firebase Setup (Step 5)

1. Create a Firebase project (Spark plan) and add a Web app.
2. Enable Google sign-in.
3. Add authorized domains (localhost + GitHub Pages domain).
4. Create a Firestore database (production mode).
5. Firestore rules: copy `firestore.rules` into the Rules editor and publish.
6. Seed league access:
   - Members: `leagues/{leagueId}/members/{email}` with `email`, `name`, `isAdmin`, `createdAt`.
   - Doc id is the lower-case email address used to sign in with Google.
7. Add env vars from `.env.example` (set `VITE_LEAGUE_ID` to your league ID) and restart dev server.

## Secrets and Variables (GitHub Actions)

Set these in GitHub: `Settings → Secrets and variables → Actions`.

Secrets:
- `FOOTBALL_DATA_TOKEN` (football-data.org API token used by `.github/workflows/update-matches.yml`)

Variables (public web config used by Vite build):
- `VITE_FIREBASE_API_KEY`
- `VITE_FIREBASE_AUTH_DOMAIN`
- `VITE_FIREBASE_PROJECT_ID`
- `VITE_FIREBASE_STORAGE_BUCKET`
- `VITE_FIREBASE_MESSAGING_SENDER_ID`
- `VITE_FIREBASE_APP_ID`
- `VITE_LEAGUE_ID`

## Seed Production Firestore (local only)

Do this from your machine (never in CI). Requires a local service account JSON.

```sh
export GOOGLE_APPLICATION_CREDENTIALS="$PWD/.secrets/firebase-adminsdk.json"
export FIREBASE_PROJECT_ID="your-project-id"
export LEAGUE_ID="default"
# Optional: export MEMBERS_PATH="scripts/seed-data/members.json"
npm run seed:prod
```

By default, `seed:prod` reads `public/data/members.json` (or `scripts/seed-data/members.json` if present).

## Data Updates (Fixtures/Results)

Match data is sourced from `https://api.football-data.org/v4/competitions/WC/matches`.

- Local update: set `FOOTBALL_DATA_TOKEN` and run `npm run update-matches`
- Local leaderboard refresh: `npm run update-leaderboard`
  - Uses Firestore league data (`members`, `picks`, `bracket-*`) when service-account credentials are available (`GOOGLE_APPLICATION_CREDENTIALS` or local `firebase-adminsdk.json`).
  - Falls back to `public/data/*.json` only when Firestore credentials/project config are unavailable.
- Local snapshot refresh (matches + leaderboard): `npm run update-snapshots`
- GitHub Actions: `.github/workflows/update-matches.yml` (daily + manual) writes `public/data/matches.json` + `public/data/leaderboard.json`
- Best third-place qualifiers: update `public/data/best-third-qualifiers.json` if it differs from computed standings
- Best third-place qualifiers updates should be deployed to refresh the bracket scoring

Notes:
- Do not commit API tokens to this repo.
- Check football-data.org for plan limits and rate caps.

## Demo Simulation CLI

Generate demo-mode data snapshots for UX/testing with 50 simulated users:

- `npm run demo:simulate -- --scenario=pre-group --users=50 --seed=101`
- `npm run demo:simulate -- --scenario=mid-group --users=50 --seed=202`
- `npm run demo:simulate -- --scenario=end-group-draw-confirmed --users=50 --seed=303`
- `npm run demo:simulate -- --scenario=mid-knockout --users=50 --seed=404`
- `npm run demo:simulate -- --scenario=world-cup-final-pending --users=50 --seed=505`
- `npm run demo:simulate:all` (generates all scenarios in one run)

What it writes (demo only):
- Per-scenario snapshots under:
  - `public/data/demo/scenarios/pre-group/*`
  - `public/data/demo/scenarios/mid-group/*`
  - `public/data/demo/scenarios/end-group-draw-confirmed/*`
  - `public/data/demo/scenarios/mid-knockout/*`
  - `public/data/demo/scenarios/world-cup-final-pending/*`
- Each scenario folder contains:
  - `matches.json`
  - `members.json`
  - `picks.json`
  - `bracket-group.json`
  - `bracket-knockout.json`
  - `leaderboard.json`
  - `best-third-qualifiers.json`
  - `scoring.json`
  - `simulation-meta.json`

Timestamp preset behavior:
- Scenario kickoffs are generated with exact Pacific time slots (`America/Los_Angeles`) to exercise lock behavior.
- Scenario state controls phase progression (pre-group, mid-group, end-group + draw-confirmed, mid-knockout, world-cup-final-pending).
- Simulator also generates:
  - random best-third qualifiers data,
  - knockout draw team assignments from qualified teams,
  - knockout winners/results progression per scenario status.
- Knockout progression consistency rules:
  - downstream knockout fixtures only resolve teams from finished upstream matches,
  - unresolved downstream knockout fixtures are normalized to `SCHEDULED` with no winner/decider,
  - in-play knockout fixtures do not publish finalized winner/decider values.
- Simulation targets high prediction density for UX testing:
  - match picks are mostly filled in every scenario,
  - group-stage top-two and best-third user picks are fully populated,
  - `best-third-qualifiers.json` always contains 8 qualifiers.

## Group Stage Detail Results

- Group-stage detail shows per-position evaluation:
  - `Your pick (1st)` + `Result (1st)`
  - `Your pick (2nd)` + `Result (2nd)`
- `Result` shows `Correct/Wrong/Pending`; `Actual: <team>` is shown only for wrong/pending rows.
- Best 8 third-place qualifiers are evaluated by membership only (order-agnostic):
  - per-pick status: `Qualified / Not qualified / Pending`
  - one section-level `Actual qualifiers` list is shown (no per-slot actual team).

## Picks Detail Page

- `Next lock` card is removed from Picks Detail (timing guidance is handled in Play Center).
- Bottom read-only helper card is removed.
- Result sections use classic page-number pagination with page size 10.

## Demo Simulation Pick Density

- `demo:simulate` now uses scenario-time-based lock evaluation for pick generation.
- Pick density follows scenario progression:
  - `pre-group`: sparse picks,
  - `mid-group`: partial fill,
  - `end-group-draw-confirmed`, `mid-knockout`, `world-cup-final-pending`: high fill density.
- Demo mode now auto-corrects stale/invalid stored demo viewer id to a valid demo member id.
- Demo data reads are scenario-scoped only:
  - app reads from `public/data/demo/scenarios/<selected-scenario>/...`
  - no fallback to `public/data/demo/*.json`

## Deploy (GitHub Pages)

This repo includes a workflow at `.github/workflows/deploy-pages.yml` that builds the Vite app and deploys `dist/` to GitHub Pages on pushes to `main`.

1. Ensure GitHub Actions variables/secrets are set (see above).
2. Commit and push to `main`: `git add -A && git commit -m "Deploy" && git push`
3. In GitHub: `Settings → Pages → Build and deployment → Source: GitHub Actions`
4. Wait for `Actions → Deploy to GitHub Pages` to finish, then open:
   - `https://<your-username>.github.io/<repo-name>/`
