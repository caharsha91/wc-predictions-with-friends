# wc-predictions-with-friends

Simple World Cup predictions app for a private league with my friends: picks, points, and bragging rights.

## App Flow (Current)

- `/` redirects to `/play`
- `/play` play center workspace (default member entry)
- `/play/picks` picks workspace
- `/play/group-stage` group stage predictions
- `/play/bracket` knockout bracket editor and review
- `/play/league` standings
- `/demo/play` demo play center (admin only)
- `/demo/play/picks` demo picks workspace (admin only)
- `/demo/play/group-stage` demo group stage predictions (admin only)
- `/demo/play/bracket` demo knockout workspace (admin only)
- `/demo/play/league` demo standings (admin only)
- `/demo/admin/controls` demo controls (scenario/viewer/session) (admin only)
- `/demo/admin/players` demo member manager (admin only)
- `/demo/admin/exports` demo export tools (admin only)
- `/admin/players` member manager (admin only)
- `/admin/exports` export tools (admin only)
- `/settings` account and appearance settings
- `/login` sign-in guidance
- `/access-denied` unauthorized state
- `*` not found

Snapshot data lives in `public/data/` (`matches.json`, `members.json`, `picks.json`, `scoring.json`, `bracket-group.json`, `bracket-knockout.json`, `best-third-qualifiers.json`, `leaderboard.json`).
Demo snapshot data lives in `public/data/demo/` with the same file set.
`leaderboard.json` is generated by the leaderboard update script; do not hand-edit entries.

## Demo Mode Data + Storage

- Demo routes (`/demo/play/*`, `/demo/admin/*`) read from `public/data/demo/*`.
- Demo-mode caches and local edits are namespaced in localStorage to avoid mixing with normal mode.
- Demo mode disables Firestore writes (including picks, group stage, knockout, members admin edits, theme sync, and export backfills).
- Demo localStorage keys are explicitly cleared on logout and on page exit while in demo mode.
- `/demo/admin/controls` lets admins:
  - set scenario-based demo "now" timestamps for lock testing,
  - switch the active demo viewer user,
  - reload demo snapshots after running the simulation CLI,
  - clear demo session keys.

## Docs

- `skills.md` Codex project guide and pointers.
- `docs/pages/` page summaries for each route.

## How the App Works (Contributor Guide)

- Entry + routing: `src/main.tsx` bootstraps the app and applies theme attributes; `src/ui/App.tsx` defines routes; `src/ui/Layout.tsx` owns the shared header/nav shell.
- Data flow: `src/ui/hooks/*` fetches from Firestore when enabled (see `src/lib/firebase.ts`), otherwise reads mock JSON from `public/data/`. Static JSON fetches use HTTP caching + localStorage TTL to reduce reads. Picks updates flow through `src/lib/picks.ts`.
- Match grouping/locks: `src/lib/matches.ts` handles lock calculations and stage/date helpers.
- Scoring: `src/lib/scoring.ts` computes pick + bracket points from `public/data/scoring.json`, surfaced in leaderboard views.
- Theming: base tokens live in `src/styles/theme.css`, palettes in `src/styles/themes.css`, and state in `src/theme/ThemeProvider.tsx` with localStorage persistence + optional Firestore sync.
- Styling: Tailwind + shadcn/ui components, with remaining page-specific styles in `src/ui/styles.css`.
- UI primitives: reusable components are in `src/ui/components/ui/` and app-specific components in `src/ui/components/`.

## Dev

1. Install Node.js (v20+ recommended)
2. Install deps: `npm install`
3. Run: `npm run dev`

## Local Firebase (Emulators)

1. Install the Firebase CLI (one-time).
2. Ensure `.env.local` includes:
   - `VITE_USE_FIREBASE_EMULATORS=true`
   - `VITE_FIREBASE_EMULATOR_HOST=127.0.0.1`
   - `VITE_FIREBASE_AUTH_EMULATOR_PORT=9099`
   - `VITE_FIRESTORE_EMULATOR_PORT=8080`
3. Start emulators in a separate terminal: `firebase emulators:start`
4. Seed emulator data:
   - `VITE_USE_FIREBASE_EMULATORS=true FIREBASE_PROJECT_ID=demo-wc-predictions node scripts/seedEmulators.js`
5. Run the app: `npm run dev`

## Pick Locks (PST)

- Match picks lock 30 minutes before kickoff.
- Bracket group qualifiers + best third-place picks lock at 11:59 PM PST on the day before the first group match day.
- Bracket knockout picks lock at 11:59 PM PST on the day before the first knockout match day.
- Knockout eventual winner picks are independent of the result selection.

## Bracket Guides

- Group stage guide highlights group qualifiers + best third-place pick flow.
- Knockout guide explains inline team-pill picks and champion badge from the Final.

## Admin

- `/admin/players` is admin-only and manages member allowlist + admin role assignment.

## Firestore Data Model (when enabled)

- `leagues/{leagueId}/members/{email}` (doc id is lower-case email)
  - `email`, `name`, `handle?`, `isAdmin?`, `createdAt?`, `theme?`
- `leagues/{leagueId}/picks/{userId}` → one doc per user with all match picks
- `leagues/{leagueId}/bracket-group/{userId}` → one doc per user (group + best thirds)
- `leagues/{leagueId}/bracket-knockout/{userId}` → one doc per user (knockout winners)

JSON mirrors for local mode: `public/data/members.json`, `public/data/picks.json`, `public/data/bracket-group.json`, `public/data/bracket-knockout.json`.

## Firebase Setup (Step 5)

1. Create a Firebase project (Spark plan) and add a Web app.
2. Enable Google sign-in.
3. Add authorized domains (localhost + GitHub Pages domain).
4. Create a Firestore database (production mode).
5. Firestore rules: copy `firestore.rules` into the Rules editor and publish.
6. Seed league access:
   - Members: `leagues/{leagueId}/members/{email}` with `email`, `name`, `isAdmin`, `createdAt`.
   - Doc id is the lower-case email address used to sign in with Google.
7. Add env vars from `.env.example` (set `VITE_LEAGUE_ID` to your league ID) and restart dev server.

## Secrets and Variables (GitHub Actions)

Set these in GitHub: `Settings → Secrets and variables → Actions`.

Secrets:
- `FOOTBALL_DATA_TOKEN` (football-data.org API token used by `.github/workflows/update-matches.yml`)

Variables (public web config used by Vite build):
- `VITE_FIREBASE_API_KEY`
- `VITE_FIREBASE_AUTH_DOMAIN`
- `VITE_FIREBASE_PROJECT_ID`
- `VITE_FIREBASE_STORAGE_BUCKET`
- `VITE_FIREBASE_MESSAGING_SENDER_ID`
- `VITE_FIREBASE_APP_ID`
- `VITE_LEAGUE_ID`

## Seed Production Firestore (local only)

Do this from your machine (never in CI). Requires a local service account JSON.

```sh
export GOOGLE_APPLICATION_CREDENTIALS="$PWD/.secrets/firebase-adminsdk.json"
export FIREBASE_PROJECT_ID="your-project-id"
export LEAGUE_ID="default"
# Optional: export MEMBERS_PATH="scripts/seed-data/members.json"
npm run seed:prod
```

By default, `seed:prod` reads `public/data/members.json` (or `scripts/seed-data/members.json` if present).

## Data Updates (Fixtures/Results)

Match data is sourced from `https://api.football-data.org/v4/competitions/WC/matches`.

- Local update: set `FOOTBALL_DATA_TOKEN` and run `npm run update-matches`
- Local leaderboard refresh: `npm run update-leaderboard`
  - Uses Firestore league data (`members`, `picks`, `bracket-*`) when service-account credentials are available (`GOOGLE_APPLICATION_CREDENTIALS` or local `firebase-adminsdk.json`).
  - Falls back to `public/data/*.json` only when Firestore credentials/project config are unavailable.
- Local snapshot refresh (matches + leaderboard): `npm run update-snapshots`
- GitHub Actions: `.github/workflows/update-matches.yml` (daily + manual) writes `public/data/matches.json` + `public/data/leaderboard.json`
- Best third-place qualifiers: update `public/data/best-third-qualifiers.json` if it differs from computed standings
- Best third-place qualifiers updates should be deployed to refresh the bracket scoring

Notes:
- Do not commit API tokens to this repo.
- Check football-data.org for plan limits and rate caps.

## Demo Simulation CLI

Generate demo-mode data snapshots for UX/testing with 50 simulated users:

- `npm run demo:simulate -- --scenario=pre-group --users=50 --seed=101`
- `npm run demo:simulate -- --scenario=mid-group --users=50 --seed=202`
- `npm run demo:simulate -- --scenario=end-group-draw-confirmed --users=50 --seed=303`
- `npm run demo:simulate -- --scenario=mid-knockout --users=50 --seed=404`
- `npm run demo:simulate -- --scenario=world-cup-final-pending --users=50 --seed=505`

What it writes (demo only):
- `public/data/demo/matches.json`
- `public/data/demo/members.json`
- `public/data/demo/picks.json`
- `public/data/demo/bracket-group.json`
- `public/data/demo/bracket-knockout.json`
- `public/data/demo/leaderboard.json`
- `public/data/demo/best-third-qualifiers.json`
- `public/data/demo/scoring.json`
- `public/data/demo/simulation-meta.json`

Timestamp preset behavior:
- Scenario kickoffs are generated with exact Pacific time slots (`America/Los_Angeles`) to exercise lock behavior.
- Scenario state controls phase progression (pre-group, mid-group, end-group + draw-confirmed, mid-knockout, world-cup-final-pending).
- Simulator also generates:
  - random best-third qualifiers data,
  - knockout draw team assignments from qualified teams,
  - knockout winners/results progression per scenario status.

## Deploy (GitHub Pages)

This repo includes a workflow at `.github/workflows/deploy-pages.yml` that builds the Vite app and deploys `dist/` to GitHub Pages on pushes to `main`.

1. Ensure GitHub Actions variables/secrets are set (see above).
2. Commit and push to `main`: `git add -A && git commit -m "Deploy" && git push`
3. In GitHub: `Settings → Pages → Build and deployment → Source: GitHub Actions`
4. Wait for `Actions → Deploy to GitHub Pages` to finish, then open:
   - `https://<your-username>.github.io/<repo-name>/`
